%==== Script of 3DEnVar===
%=== Based in the Paper: "A review of operational methods of variational 
% and ensemble-variational data assimilation" R.N. Bannister
clear all
close all
clc

%==== Parameters====

%===Simulation Parameters===
tsim=500; %Time steps simulation
dt=0.01; %step length

%===Model Parameters===
load Xreal %True state
tic
n=40; %Number of states
F=8; %External force

%===Observation Parameters===
p_obsersation=1;  %Fraction of observabled states
m=round(n*p_obsersation); % Number of observations
sigma=0.01; %Observation error
R=sigma^2*eye(m,m);
inR=(1/sigma^2)*eye(m,m);
H = eye(n,n); 
salidas=randperm(n,m);
H = H(salidas,:);  %Matrix that maps the state space into the observation space

M=25;
y=zeros(m,tsim);
tipo=7;
frequency=10; % Frequency of observations
tsim=frequency*M;
muestreo=frequency:frequency:tsim;

%=== DA parameters===
N=80; % Number of ensemble
r=15; %Localization radius
global gam
gam=4; %Gamma observation operator
eps=0.01; %Tolerance rho calculation
q=round(log2(1/eps)); %Number of iterations rho calculation
inner=100; % Max Number of inner iterations
tolerance_inner=10^-2;
add_inflation=0.1; 
% gam=1,N=80--infla=0.5,N=40--infla=0.5,N=20--infla=0.5;
% gam=2,N=80--infla=0.5,N=40--infla=0.5,N=20--infla=0.5;
% gam=3,N=80--infla=0.5,N=40--infla=0.5,N=20--infla=0.5;
% gam=4,N=80--infla=0.1,N=40--infla=0.1,N=20--infla=0.05;
% gam=5,N=80--infla=0.1,N=40--infla=0.1,N=20--infla=0.05;

%====Simulation====
%===Initialization===
xb=zeros(n,tsim,N); % Background State. Dimensions=(states,time,ensemble member)
Xb=zeros(n,N);

%===Ensemble generation===
ensemble_sparse=10;
x0=ensemble_sparse*rand(n,N); %The ensemble is generated by the initial condition
xb(:,1,:)=x0;
xa=xb;
meanxb=mean(xb(:,1,:),3);
Hx = operador(salidas,meanxb,tipo);
XB_time=zeros(n,N,tsim);
meanxa(:,1)=meanxb;
muestra=0;
for i=2:tsim
%===Outer Loop===    
    for Nen=1:N %Propagation in time of all the ensemble members
        [xb(:,i,Nen),t]=Lorenz_96_one_step(1,dt,squeeze(xa(:,i-1,Nen)),F);  
    end
 meanxb=mean(xb(:,i,:),3); %Ensemble mean
 if sum(muestreo==i)   %Validation if there are a observation available
 muestra=muestra+1;
 for Nen=1:N
    Xb(:,Nen)= xb(:,i,Nen)-meanxb;  
 end
 Xb=Xb*sqrt(1/(N-1));   
 XB_time(:,:,i)=Xb; 
 [B,Bsquare]=Calculo_B_Cholesky(Xb,r); %Estimation of Covariance by Modified Cholesky
 inB=Calculo_inB_Cholesky(Xb,r); %Estimation of inverse Covariance by Modified Cholesky
%  Bsquare=sqrtm(B);
 y(:,i)=operador(salidas,Xreal(:,i),tipo)+sigma*randn(m,1); % Observations
 %==Inner Loop==
     alpha=zeros(n,inner);
     alpha(:,1)=rand(n,1);
     xk=zeros(n,inner);
     xk(:,1)=meanxb+Bsquare*alpha(:,1);
     H = linear_operador(salidas,meanxb,tipo);
     Q=H*Bsquare;
     yxk=operador(salidas,xk(:,1),tipo);
     d=(y(:,i)-yxk);  %Innovation Matriz
     k=2;
     norma(1,i)=tolerance_inner;
     flaq=0;
      while norma(k-1,i)>=tolerance_inner && k<inner && flaq<2 
         
          
         alpha(:,k)= pinv((eye(n,1)+Q'*inR*Q),0.)*(Q'*inR*d)-sum(alpha(:,1:k-1),2);
         %=Calculate of rho=
         
         [rho,J1,J2,J3]=rho_calculation(q,xk(:,k-1),Bsquare,alpha(:,k),y(:,i),inB,inR,H,meanxb);
         
         %=Incremental=
         xk(:,k)=xk(:,k-1)+rho*Bsquare*alpha(:,k);
         yxk=operador(salidas,xk(:,k),tipo);
         d=(y(:,i)-yxk);
         norma(k,i)=norm(rho*Bsquare*alpha(:,k));
         if diff(norma(k-1:k,i))>0 
             flaq=flaq+1;          
         end
         if flaq==2
            alpha(:,k)=alpha(:,k-1); 
            xk(:,k)=xk(:,k-1);
         end
         k=k+1;
     end
     meanxa(:,i)=(xk(:,k-1));
     yxa(:,i)=operador(salidas,meanxa(:,i),tipo);
%==End Inner Loop==
%=Analysis ensemble calculation=
 for Nen=1:N
     alpha_a=(alpha(:,k-1)+real(pinv(eye(n,1)+Q'*inR*Q)^(1/2))*randn(n,1));
     xa(:,i,Nen)=(meanxa(:,i)+rho*Bsquare*alpha_a)-add_inflation/2+add_inflation*rand(n,1);
 end
  norma_error_rela(:,i)=norm((yxa(:,i)-y(:,i))./y(:,i));
  norma_error_abs(:,i)=norm((yxa(:,i)-y(:,i)));
 else
     xa(:,i,:)=xb(:,i,:);
     meanxa(:,i)=meanxb;
     yxa(:,i)=operador(salidas,meanxa(:,i),tipo);
     y(:,i)=operador(salidas,Xreal(:,i),tipo)+sigma*randn(m,1);
     norma_error_rela(:,i)=norm((yxa(:,i)-y(:,i))./y(:,i));
% %      norma_error_abs(:,i)=norm((yxa(:,i)-y(:,i)));
 end
  process=i/tsim*100
end

toc
%  
%  figure
% plot(Xreal(15,1:tsim))
% hold on
% plot(meanxa(15,1:tsim))
%  figure
% plot(Xreal(25,1:tsim))
% hold on
% plot(meanxa(25,1:tsim))
%  figure
% plot(Xreal(35,1:tsim))
% hold on
% plot(meanxa(35,1:tsim))
%  figure
% imagesc(Xreal(:,1:tsim)),caxis([-10 10]),colorbar
% figure
% imagesc(meanxa(:,1:tsim)),caxis([-10 10]),colorbar
semilogy(norma_error_rela), title('Norm Relative Error')
% figure
% semilogy(norma_error_abs), title('Norm Absolute Error')
% 
% for i=1:15
% figure
% plot(Xreal(salidas(i),1:tsim))
% hold on
% plot(meanxa(salidas(i),1:tsim))
% end